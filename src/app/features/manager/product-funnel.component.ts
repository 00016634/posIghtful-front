import { Component, inject, signal, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { PageLayoutComponent } from '../../shared/layouts/page-layout.component';
import {
  CardComponent, CardHeaderComponent, CardTitleComponent, CardContentComponent,
  ButtonComponent, LabelComponent, DialogComponent, DialogHeaderComponent,
  DialogTitleComponent, DialogFooterComponent,
} from '../../shared/ui';
import { ProductService } from '../../services/product.service';
import { ToastService } from '../../shared/ui/toast.service';

@Component({
  selector: 'app-product-funnel',
  standalone: true,
  imports: [
    PageLayoutComponent,
    CardComponent, CardHeaderComponent, CardTitleComponent, CardContentComponent,
    ButtonComponent, LabelComponent, DialogComponent, DialogHeaderComponent,
    DialogTitleComponent, DialogFooterComponent,
  ],
  template: `
    <app-page-layout>
      <div class="mx-auto max-w-7xl space-y-6">
        <!-- Header -->
        <div class="flex items-center gap-4">
          <ui-button variant="ghost" size="icon" (click)="router.navigateByUrl('/manager')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          </ui-button>
          <div>
            <h1 class="text-2xl font-semibold">Product Conversion Funnel</h1>
            <p class="text-sm text-muted-foreground">Manage conversion stages for each product</p>
          </div>
        </div>

        <!-- Products -->
        <div class="space-y-6">
          @for (product of products(); track product.productId) {
            <ui-card>
              <ui-card-header>
                <div class="flex justify-between items-center">
                  <ui-card-title>{{ product.productName }}</ui-card-title>
                  <ui-button size="sm" (click)="addStage(product.productId)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Add Stage
                  </ui-button>
                </div>
              </ui-card-header>
              <ui-card-content>
                <div class="space-y-4">
                  @for (stage of product.stages; track stage.id; let last = $last) {
                    <div class="relative">
                      <div class="flex items-center gap-4">
                        <div class="flex-shrink-0 flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-700 font-semibold">
                          {{ stage.order }}
                        </div>
                        <div class="flex-1 bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
                          <div class="flex justify-between items-start">
                            <div class="flex-1">
                              <h3 class="font-semibold">{{ stage.name }}</h3>
                              @if (stage.description) {
                                <p class="text-sm text-muted-foreground mt-1">{{ stage.description }}</p>
                              }
                            </div>
                            <div class="flex gap-2">
                              <ui-button variant="ghost" size="icon" (click)="openEditDialog(product.productId, stage)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                              </ui-button>
                              <ui-button variant="ghost" size="icon" (click)="deleteStage(product.productId, stage.id)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                              </ui-button>
                            </div>
                          </div>
                        </div>
                      </div>
                      @if (!last) {
                        <div class="ml-5 h-6 w-0.5 bg-gray-300"></div>
                      }
                    </div>
                  }
                </div>
              </ui-card-content>
            </ui-card>
          }
        </div>
      </div>

      <!-- Edit Stage Dialog -->
      <ui-dialog [open]="editDialogOpen()" (openChange)="editDialogOpen.set($event)">
        <ui-dialog-header>
          <ui-dialog-title>Edit Stage</ui-dialog-title>
        </ui-dialog-header>
        <div class="grid gap-4 py-4">
          <div class="grid gap-2">
            <ui-label>Stage Name</ui-label>
            <input
              type="text"
              class="flex h-9 w-full rounded-md border border-input bg-input-background px-3 py-1 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
              [value]="editForm().name"
              (input)="updateEditField('name', $event)"
              required
            />
          </div>
          <div class="grid gap-2">
            <ui-label>Description</ui-label>
            <input
              type="text"
              class="flex h-9 w-full rounded-md border border-input bg-input-background px-3 py-1 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
              [value]="editForm().description"
              (input)="updateEditField('description', $event)"
              placeholder="Optional description"
            />
          </div>
        </div>
        <ui-dialog-footer>
          <ui-button variant="outline" (click)="editDialogOpen.set(false)">Cancel</ui-button>
          <ui-button (click)="saveStage()">Save Changes</ui-button>
        </ui-dialog-footer>
      </ui-dialog>
    </app-page-layout>
  `,
})
export class ProductFunnelComponent implements OnInit {
  router = inject(Router);
  private productService = inject(ProductService);
  private toastService = inject(ToastService);

  products = signal<any[]>([]);
  editDialogOpen = signal(false);
  editProductId = signal(0);
  editForm = signal({ id: 0, name: '', description: '', order: 0 });

  ngOnInit() {
    this.productService.getProductFunnels().subscribe(data => this.products.set(data));
  }

  addStage(productId: number) {
    this.products.update(products =>
      products.map(p => {
        if (p.productId === productId) {
          const newStage = {
            id: Date.now(),
            name: 'New Stage',
            order: p.stages.length + 1,
            description: '',
          };
          return { ...p, stages: [...p.stages, newStage] };
        }
        return p;
      })
    );
    this.toastService.show('Stage Added', 'Stage added successfully');
  }

  updateEditField(field: string, event: Event) {
    const value = (event.target as HTMLInputElement).value;
    this.editForm.update(f => ({ ...f, [field]: value }));
  }

  openEditDialog(productId: number, stage: any) {
    this.editProductId.set(productId);
    this.editForm.set({ id: stage.id, name: stage.name, description: stage.description, order: stage.order });
    this.editDialogOpen.set(true);
  }

  saveStage() {
    const form = this.editForm();
    this.products.update(products =>
      products.map(p => {
        if (p.productId === this.editProductId()) {
          return {
            ...p,
            stages: p.stages.map((s: any) =>
              s.id === form.id ? { ...s, name: form.name, description: form.description } : s
            ),
          };
        }
        return p;
      })
    );
    this.editDialogOpen.set(false);
    this.toastService.show('Stage Updated', 'Stage updated successfully');
  }

  deleteStage(productId: number, stageId: number) {
    this.products.update(products =>
      products.map(p => {
        if (p.productId === productId) {
          const stages = p.stages
            .filter((s: any) => s.id !== stageId)
            .map((s: any, idx: number) => ({ ...s, order: idx + 1 }));
          return { ...p, stages };
        }
        return p;
      })
    );
    this.toastService.show('Stage Deleted', 'Stage deleted successfully');
  }
}
