import { Component, signal, inject, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { CardComponent, CardHeaderComponent, CardTitleComponent, CardDescriptionComponent, CardContentComponent, CardFooterComponent } from '../../shared/ui/card.component';
import { ButtonComponent } from '../../shared/ui/button.component';
import { BadgeComponent } from '../../shared/ui/badge.component';
import { OnboardingService } from '../../services/onboarding.service';
import { PricingPlan } from '../../models/tenant.model';

interface Plan extends PricingPlan {
  popular: boolean;
}

@Component({
  selector: 'app-platform-purchase',
  standalone: true,
  imports: [
    CardComponent,
    CardHeaderComponent,
    CardTitleComponent,
    CardDescriptionComponent,
    CardContentComponent,
    CardFooterComponent,
    ButtonComponent,
    BadgeComponent,
  ],
  template: `
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center justify-center p-4 md:p-8">
      <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Choose Your Plan</h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Select the perfect plan for your business. All plans include a 14-day free trial.
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-8 max-w-5xl w-full">
        @if (loading()) {
          <div class="col-span-3 text-center py-12 text-muted-foreground">Loading plans...</div>
        }
        @for (plan of plans(); track plan.name) {
          <ui-card [className]="plan.popular
            ? 'relative border-2 border-primary shadow-xl scale-105'
            : 'relative hover:shadow-lg transition-shadow'">
            @if (plan.popular) {
              <div class="absolute -top-3 left-1/2 -translate-x-1/2">
                <ui-badge>Most Popular</ui-badge>
              </div>
            }
            <ui-card-header className="text-center pt-8">
              <ui-card-title className="text-xl">{{ plan.name }}</ui-card-title>
              <ui-card-description>{{ plan.description }}</ui-card-description>
              <div class="mt-4">
                <span class="text-4xl font-bold text-gray-900">\${{ plan.price }}</span>
                <span class="text-muted-foreground">/month</span>
              </div>
            </ui-card-header>
            <ui-card-content>
              <ul class="space-y-3">
                @for (feature of plan.features; track feature) {
                  <li class="flex items-center gap-3 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 shrink-0">
                      <path d="M20 6 9 17l-5-5"/>
                    </svg>
                    <span class="text-gray-700">{{ feature }}</span>
                  </li>
                }
              </ul>
            </ui-card-content>
            <ui-card-footer className="justify-center pb-8">
              <ui-button
                [variant]="plan.popular ? 'default' : 'outline'"
                className="w-full"
                size="lg"
                (click)="selectPlan(plan)">
                Get Started
              </ui-button>
            </ui-card-footer>
          </ui-card>
        }
      </div>

      <p class="text-sm text-muted-foreground mt-8">
        All plans include SSL security, 99.9% uptime guarantee, and 24/7 support.
      </p>
    </div>
  `,
})
export class PlatformPurchaseComponent implements OnInit {
  private router = inject(Router);
  private onboardingService = inject(OnboardingService);

  plans = signal<Plan[]>([]);
  loading = signal(true);

  ngOnInit() {
    this.onboardingService.getPlans().subscribe({
      next: (plans) => {
        this.plans.set(
          plans.map(p => ({
            ...p,
            popular: p.name === 'Professional',
          }))
        );
        this.loading.set(false);
      },
      error: () => {
        this.loading.set(false);
      },
    });
  }

  selectPlan(plan: Plan) {
    this.onboardingService.selectedPlan.set(plan);
    this.router.navigateByUrl('/purchase/payment');
  }
}
